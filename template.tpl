___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_WRCJB",
  "version": 1,
  "displayName": "Advanced Consent Mode v2 Banner",
  "categories": [
    "MARKETING",
    "PERSONALIZATION",
    "UTILITY"
  ],
  "brand": {
    "id": "github.com_analyticskgmedia",
    "displayName": "analyticskgmedia",
    "thumbnail": "data:image/png;base64,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"
  },
  "description": "A complete GDPR-compliant consent banner with Google Consent Mode v2 integration. Features two-step consent flow, multi-language support, and full customization options.",
  "containerContexts": [
    "WEB"
  ],
  "securityGroups": []
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "GROUP",
    "name": "generalSettings",
    "displayName": "General Settings",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "TEXT",
        "name": "bannerId",
        "displayName": "Banner ID",
        "simpleValueType": true,
        "defaultValue": "kg-consent-banner",
        "help": "Unique ID for the consent banner instance"
      },
      {
        "type": "SELECT",
        "name": "defaultLanguage",
        "displayName": "Default Language",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": "en",
            "displayValue": "English"
          },
          {
            "value": "bg",
            "displayValue": "Bulgarian"
          },
          {
            "value": "hr",
            "displayValue": "Croatian"
          },
          {
            "value": "cs",
            "displayValue": "Czech"
          },
          {
            "value": "da",
            "displayValue": "Danish"
          },
          {
            "value": "nl",
            "displayValue": "Dutch"
          },
          {
            "value": "et",
            "displayValue": "Estonian"
          },
          {
            "value": "fi",
            "displayValue": "Finnish"
          },
          {
            "value": "fr",
            "displayValue": "French"
          },
          {
            "value": "de",
            "displayValue": "German"
          },
          {
            "value": "el",
            "displayValue": "Greek"
          },
          {
            "value": "hu",
            "displayValue": "Hungarian"
          },
          {
            "value": "ga",
            "displayValue": "Irish"
          },
          {
            "value": "it",
            "displayValue": "Italian"
          },
          {
            "value": "lv",
            "displayValue": "Latvian"
          },
          {
            "value": "lt",
            "displayValue": "Lithuanian"
          },
          {
            "value": "mt",
            "displayValue": "Maltese"
          },
          {
            "value": "pl",
            "displayValue": "Polish"
          },
          {
            "value": "pt",
            "displayValue": "Portuguese"
          },
          {
            "value": "ro",
            "displayValue": "Romanian"
          },
          {
            "value": "sk",
            "displayValue": "Slovak"
          },
          {
            "value": "si",
            "displayValue": "Slovene"
          },
          {
            "value": "es",
            "displayValue": "Spanish"
          },
          {
            "value": "sv",
            "displayValue": "Swedish"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "en"
      },
      {
        "type": "CHECKBOX",
        "name": "autoDetectLanguage",
        "checkboxText": "Auto-detect language from URL",
        "simpleValueType": true,
        "defaultValue": true,
        "help": "Automatically detect language from URL path (e.g., /en/, /de/)"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "consentSettings",
    "displayName": "Consent Mode Settings",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "adsDataRedaction",
        "checkboxText": "Enable ads_data_redaction",
        "simpleValueType": true,
        "defaultValue": true,
        "help": "Redact ads data when ad_storage is denied"
      },
      {
        "type": "CHECKBOX",
        "name": "urlPassthrough",
        "checkboxText": "Enable url_passthrough",
        "simpleValueType": true,
        "defaultValue": true,
        "help": "Pass ad click information through URL parameters"
      },
      {
        "type": "TEXT",
        "name": "waitForUpdate",
        "displayName": "Wait for update (milliseconds)",
        "simpleValueType": true,
        "defaultValue": "2000",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          },
          {
            "type": "POSITIVE_NUMBER"
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "consentLogging",
    "displayName": "Consent Logging (GDPR Compliance)",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "enableConsentLogging",
        "checkboxText": "Enable consent logging to Google Sheets",
        "simpleValueType": true,
        "defaultValue": false,
        "help": "Log all consent actions to a Google Sheet for GDPR compliance and audit purposes"
      },
      {
        "type": "TEXT",
        "name": "consentLogEndpoint",
        "displayName": "Google Apps Script Web App URL",
        "simpleValueType": true,
        "defaultValue": "",
        "help": "The URL of your deployed Google Apps Script web app. See documentation for setup instructions.",
        "enablingConditions": [
          {
            "paramName": "enableConsentLogging",
            "paramValue": true,
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "bannerVersion",
        "displayName": "Banner/Policy Version",
        "simpleValueType": true,
        "defaultValue": "1.0",
        "help": "Version identifier for your consent banner or privacy policy. Update this when you make significant changes to track which version users consented to.",
        "enablingConditions": [
          {
            "paramName": "enableConsentLogging",
            "paramValue": true,
            "type": "EQUALS"
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "appearance",
    "displayName": "Appearance",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "TEXT",
        "name": "primaryColor",
        "displayName": "Primary Button Color",
        "simpleValueType": true,
        "defaultValue": "#2563eb",
        "help": "Color for the \u0027Accept All\u0027 button"
      },
      {
        "type": "TEXT",
        "name": "primaryTextColor",
        "displayName": "Primary Button Text Color",
        "simpleValueType": true,
        "defaultValue": "#ffffff"
      },
      {
        "type": "TEXT",
        "name": "secondaryColor",
        "displayName": "Secondary Button Color",
        "simpleValueType": true,
        "defaultValue": "#f3f4f6",
        "help": "Color for \u0027Details\u0027 and \u0027Reject All\u0027 buttons"
      },
      {
        "type": "TEXT",
        "name": "secondaryTextColor",
        "displayName": "Secondary Button Text Color",
        "simpleValueType": true,
        "defaultValue": "#374151"
      },
      {
        "type": "TEXT",
        "name": "backgroundColor",
        "displayName": "Banner Background Color",
        "simpleValueType": true,
        "defaultValue": "#ffffff"
      },
      {
        "type": "TEXT",
        "name": "textColor",
        "displayName": "Text Color",
        "simpleValueType": true,
        "defaultValue": "#111827"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "logos",
    "displayName": "Logo",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "TEXT",
        "name": "websiteLogo",
        "displayName": "Website Logo URL",
        "simpleValueType": true,
        "help": "URL to your website logo (optional)"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "privacyLinks",
    "displayName": "Privacy Policy Links",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "privacyPolicyUrls",
        "displayName": "Privacy Policy URLs by Language",
        "simpleTableColumns": [
          {
            "defaultValue": "en",
            "displayName": "Language Code",
            "name": "language",
            "type": "SELECT",
            "selectItems": [
              {
                "value": "en",
                "displayValue": "English"
              },
              {
                "value": "bg",
                "displayValue": "Bulgarian"
              },
              {
                "value": "hr",
                "displayValue": "Croatian"
              },
              {
                "value": "cs",
                "displayValue": "Czech"
              },
              {
                "value": "da",
                "displayValue": "Danish"
              },
              {
                "value": "nl",
                "displayValue": "Dutch"
              },
              {
                "value": "et",
                "displayValue": "Estonian"
              },
              {
                "value": "fi",
                "displayValue": "Finnish"
              },
              {
                "value": "fr",
                "displayValue": "French"
              },
              {
                "value": "de",
                "displayValue": "German"
              },
              {
                "value": "el",
                "displayValue": "Greek"
              },
              {
                "value": "hu",
                "displayValue": "Hungarian"
              },
              {
                "value": "ga",
                "displayValue": "Irish"
              },
              {
                "value": "it",
                "displayValue": "Italian"
              },
              {
                "value": "lv",
                "displayValue": "Latvian"
              },
              {
                "value": "lt",
                "displayValue": "Lithuanian"
              },
              {
                "value": "mt",
                "displayValue": "Maltese"
              },
              {
                "value": "pl",
                "displayValue": "Polish"
              },
              {
                "value": "pt",
                "displayValue": "Portuguese"
              },
              {
                "value": "ro",
                "displayValue": "Romanian"
              },
              {
                "value": "sk",
                "displayValue": "Slovak"
              },
              {
                "value": "sl",
                "displayValue": "Slovene"
              },
              {
                "value": "es",
                "displayValue": "Spanish"
              },
              {
                "value": "sv",
                "displayValue": "Swedish"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Privacy Policy URL",
            "name": "url",
            "type": "TEXT"
          }
        ],
        "newRowButtonText": "Add Language"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "floatingButton",
    "displayName": "Floating Button Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "showFloatingButton",
        "checkboxText": "Show floating settings button",
        "simpleValueType": true,
        "defaultValue": true,
        "help": "Display a floating button for users to change cookie preferences after closing the banner"
      },
      {
        "type": "SELECT",
        "name": "floatingButtonPosition",
        "displayName": "Button Position",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "bottom-left",
            "displayValue": "Bottom Left"
          },
          {
            "value": "bottom-right",
            "displayValue": "Bottom Right"
          },
          {
            "value": "top-left",
            "displayValue": "Top Left"
          },
          {
            "value": "top-right",
            "displayValue": "Top Right"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "bottom-left",
        "enablingConditions": [
          {
            "paramName": "showFloatingButton",
            "paramValue": true,
            "type": "EQUALS"
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "advanced",
    "displayName": "Advanced Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "TEXT",
        "name": "cookieName",
        "displayName": "Consent Cookie Name",
        "simpleValueType": true,
        "defaultValue": "kg_consent_preferences",
        "help": "Name of the cookie storing consent preferences"
      },
      {
        "type": "TEXT",
        "name": "cookieExpiry",
        "displayName": "Cookie Expiry (days)",
        "simpleValueType": true,
        "defaultValue": "365",
        "valueValidators": [
          {
            "type": "POSITIVE_NUMBER"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "scriptUrl",
        "displayName": "External Script URL",
        "simpleValueType": true,
        "defaultValue": "https://kg-media.eu/banner/banner-v1.js",
        "help": "URL to the banner JavaScript file"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

// Import required APIs
const injectScript = require('injectScript');
const setInWindow = require('setInWindow');
const callInWindow = require('callInWindow');
const makeNumber = require('makeNumber');
const makeString = require('makeString');
const log = require('logToConsole');
const queryPermission = require('queryPermission');
const createQueue = require('createQueue');
const setDefaultConsentState = require('setDefaultConsentState');
const updateConsentState = require('updateConsentState');
const getCookieValues = require('getCookieValues');
const JSON = require('JSON');

// Get template parameters
const bannerId = data.bannerId;
const defaultLanguage = data.defaultLanguage;
const autoDetectLanguage = data.autoDetectLanguage;
const adsDataRedaction = data.adsDataRedaction;
const urlPassthrough = data.urlPassthrough;
const waitForUpdate = makeNumber(data.waitForUpdate);
const cookieName = data.cookieName;
const cookieExpiry = makeNumber(data.cookieExpiry);
const scriptUrl = data.scriptUrl;
const showFloatingButton = data.showFloatingButton;
const floatingButtonPosition = data.floatingButtonPosition;

// Consent logging settings
const enableConsentLogging = data.enableConsentLogging;
const consentLogEndpoint = data.consentLogEndpoint;
const bannerVersion = data.bannerVersion || '1.0';

// Appearance settings
const appearance = {
  primaryColor: data.primaryColor,
  primaryTextColor: data.primaryTextColor,
  secondaryColor: data.secondaryColor,
  secondaryTextColor: data.secondaryTextColor,
  backgroundColor: data.backgroundColor,
  textColor: data.textColor
};

// Logo settings
const logos = {
  website: data.websiteLogo
};

// Privacy policy URLs
const privacyPolicyUrls = {};
if (data.privacyPolicyUrls) {
  data.privacyPolicyUrls.forEach(function(item) {
    privacyPolicyUrls[item.language] = item.url;
  });
}

// Create dataLayer push queue
const dataLayerPush = createQueue('dataLayer');

// Helper function to get consent state from cookie
function getConsentFromCookie() {
  const cookieValue = getCookieValues(cookieName);
  if (cookieValue && cookieValue.length > 0) {
    // Parse JSON safely without try/catch
    const parsed = JSON.parse(cookieValue[0]);
    if (parsed && typeof parsed === 'object') {
      return parsed;
    }
  }
  return null;
}

// Set default consent state
function setDefaultConsent() {
  const savedConsent = getConsentFromCookie();
  
  const defaultSettings = {
    'ad_storage': savedConsent ? savedConsent.ad_storage : 'denied',
    'ad_user_data': savedConsent ? savedConsent.ad_user_data : 'denied',
    'ad_personalization': savedConsent ? savedConsent.ad_personalization : 'denied',
    'analytics_storage': savedConsent ? savedConsent.analytics_storage : 'denied',
    'functionality_storage': savedConsent ? savedConsent.functionality_storage : 'denied',
    'personalization_storage': savedConsent ? savedConsent.personalization_storage : 'denied',
    'security_storage': 'granted',
    'wait_for_update': waitForUpdate
  };
  
  // Set the main consent defaults
  setDefaultConsentState(defaultSettings);
  
  // Set ads_data_redaction in a separate gtag call
  if (adsDataRedaction) {
    callInWindow('gtag', 'set', 'ads_data_redaction', true);
  }
  
  // Set url_passthrough in a separate gtag call
  if (urlPassthrough) {
    callInWindow('gtag', 'set', 'url_passthrough', true);
  }
  
  // Push to dataLayer for debugging (only consent types)
  const consentSettingsForDataLayer = {
    'ad_storage': defaultSettings.ad_storage,
    'ad_user_data': defaultSettings.ad_user_data,
    'ad_personalization': defaultSettings.ad_personalization,
    'analytics_storage': defaultSettings.analytics_storage,
    'functionality_storage': defaultSettings.functionality_storage,
    'personalization_storage': defaultSettings.personalization_storage,
    'security_storage': defaultSettings.security_storage
  };
  
  dataLayerPush({
    'event': 'consent_default',
    'consent_settings': consentSettingsForDataLayer
  });
  
  // If we have saved consent, also fire update event
  if (savedConsent) {
    updateConsentState({
      'ad_storage': savedConsent.ad_storage,
      'ad_user_data': savedConsent.ad_user_data,
      'ad_personalization': savedConsent.ad_personalization,
      'analytics_storage': savedConsent.analytics_storage,
      'functionality_storage': savedConsent.functionality_storage,
      'personalization_storage': savedConsent.personalization_storage,
      'security_storage': 'granted'
    });
    
    dataLayerPush({
      'event': 'consent_update',
      'consent_settings': savedConsent
    });
  }
}

// Initialize consent banner
function initConsentBanner() {
  // Set configuration
  const config = {
    bannerId: bannerId,
    defaultLanguage: defaultLanguage,
    autoDetectLanguage: autoDetectLanguage,
    cookieName: cookieName,
    cookieExpiry: cookieExpiry,
    appearance: appearance,
    logos: logos,
    privacyPolicyUrls: privacyPolicyUrls,
    showFloatingButton: showFloatingButton,
    floatingButtonPosition: floatingButtonPosition,
    // Consent logging configuration
    enableConsentLogging: enableConsentLogging,
    consentLogEndpoint: consentLogEndpoint,
    bannerVersion: bannerVersion,
    onConsentUpdate: function(consent) {
      // Update consent state
      updateConsentState({
        'ad_storage': consent.ad_storage,
        'ad_user_data': consent.ad_user_data,
        'ad_personalization': consent.ad_personalization,
        'analytics_storage': consent.analytics_storage,
        'functionality_storage': consent.functionality_storage,
        'personalization_storage': consent.personalization_storage,
        'security_storage': 'granted'
      });
      
      // Push to dataLayer
      dataLayerPush({
        'event': 'consent_update',
        'consent_settings': consent
      });
    }
  };
  
  // Set configuration in window
  setInWindow('kgConsentConfig', config, true);
  
  // Initialize the banner
  callInWindow('initKGConsentBanner');
}

// Set default consent immediately
setDefaultConsent();

// Load external script
if (queryPermission('inject_script', scriptUrl)) {
  injectScript(scriptUrl, function() {
    log('Consent banner script loaded successfully');
    initConsentBanner();
  }, function() {
    log('Failed to load consent banner script');
    data.gtmOnFailure();
  });
} else {
  log('Permission denied for script injection');
  data.gtmOnFailure();
}

// Call data.gtmOnSuccess when the tag is finished.
data.gtmOnSuccess();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://kg-media.eu/banner/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "kgConsentConfig"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "initKGConsentBanner"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "dataLayer"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "gtag"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_consent",
        "versionId": "1"
      },
      "param": [
        {
          "key": "consentTypes",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_user_data"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_personalization"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "analytics_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "functionality_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "personalization_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "security_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "kg_consent_preferences"
              },
              {
                "type": 1,
                "string": "kg_consent_id"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 6/5/2025

This template provides a complete GDPR-compliant consent banner with Google Consent Mode v2 integration.

Features:
- Two-step consent flow
- Multi-language support (all 24 official EU languages)
- Full customization options
- Responsive design
- WCAG compliance
- Lightweight implementation
- Optional floating settings button
- Consent logging to Google Sheets for GDPR compliance

Version 2.0:
- Added consent logging feature for GDPR compliance
- Consent actions are logged to Google Sheets via Apps Script
- Persistent consent ID for tracking user consent history
- Banner version tracking for policy changes

Version 1.2:
- Added complete EU language support (24 languages)
- Fixed Slovenian language code (si)
- Improved mobile button layout
- UI enhancements

Version 1.1:
- Added floating button position control
- Removed company logo field
- Improved mobile responsiveness

For the external JavaScript file and language translations, visit:
https://github.com/analyticskgmedia/gtm-consent-banner


